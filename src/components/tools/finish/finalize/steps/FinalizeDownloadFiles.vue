<script lang="ts" setup>
/**
 * En komponent för att ladda ner en .gredorfardig-fil som innehåller den
 * färdiga årsredovisningen.
 *
 * Komponenten ger användaren möjlighet att ladda ner en JSON-fil med
 * årsredovisningsdata, som kommer att behövas efter årsstämman, när
 * årsredovisningen skickas in till Bolagsverket
 */

import type { Arsredovisning } from "@/model/arsredovisning/Arsredovisning.ts";
import CommonWizardButtons, {
  type CommonWizardButtonsEmits,
} from "@/components/common/CommonWizardButtons.vue";
import type { CommonStepProps } from "@/components/tools/finish/common/steps/CommonStepProps.ts";
import type { DataContainer } from "@/model/DataContainer.ts";
import { requestSaveFile } from "@/util/fileUtils.ts";
import { ref } from "vue";
import CommonModalSubtitle from "@/components/common/CommonModalSubtitle.vue";

const props = defineProps<
  CommonStepProps & {
    /** Årsredovisningen som ska skickas in till Bolagsverket. */
    arsredovisning: Arsredovisning;

    /** Årsredovisningen i iXBRL-format. */
    ixbrl: string;
  }
>();

const emit = defineEmits<CommonWizardButtonsEmits>();

const hasDownloadedGredorfardig = ref<boolean>(false);
const hasDownloadedPdf = ref<boolean>(false);

function exportGredorfardig() {
  const dataContainer: DataContainer<Arsredovisning> = {
    dataType: "arsredovisning_fardig",
    version: 1,
    data: props.arsredovisning,
  };

  requestSaveFile(
    JSON.stringify(dataContainer),
    `Arsredovisning_${new Date().getTime()}.gredorfardig`,
    "application/json",
  );

  hasDownloadedGredorfardig.value = true;
}

async function exportUnsignedPdf() {
  if (!props.ixbrl) {
    return;
  }

  const printWindow = window.open("", "", "popup,width=800,height=800");
  if (!printWindow) {
    return;
  }

  const htmlToWrite = `${props.ixbrl}
  <script type="text/javascript">
    setTimeout(() => {
      window.print();
      setTimeout(() => {
        window.close();
      }, 250);
    }, 250);
  <\/script>
  `;

  printWindow.document.open();
  printWindow.document.write(htmlToWrite);

  hasDownloadedPdf.value = true;
}
</script>

<template>
  <div>
    <CommonModalSubtitle>
      Steg {{ currentStepNumber }}/{{ numSteps }}: Ladda ner filer
    </CommonModalSubtitle>

    <div class="file-zone">
      <div class="download-zone">
        <button class="btn btn-primary" @click="exportGredorfardig">
          Ladda ner .gredorfardig-fil
        </button>
      </div>

      <p>
        Du kommer behöva .gredorfardig-filen senare när du laddar upp
        årsredovisningen till Bolagsverket.
      </p>
    </div>

    <div class="file-zone">
      <div class="download-zone">
        <button class="btn btn-primary" @click="exportUnsignedPdf">
          Skriv ut årsredovisningen
        </button>
      </div>

      <p>
        Efter att du har skrivit ut årsredovisningen är det
        <strong>mycket viktigt</strong> att du signerar den. Gredors
        rekommendation är att skriva ut årsredovisningen till en PDF-fil och
        sedan använda gratistjänten
        <a href="https://elektronisksignering.se/" target="_blank"
          >elektronisksignering.se</a
        >
        för att signera den digitalt (men du kan också skriva ut den på papper
        och signera för hand).
      </p>
    </div>

    <p class="pb-4">
      När du har gjort ovanstående är ditt företag redo för årsstämma! Efter
      årsstämman kan du använda Gredor-funktionen "Ladda upp till Bolagsverket
      efter årsstämma" för att gå vidare med inlämningen.
    </p>

    <CommonWizardButtons
      :next-button-disabled="!hasDownloadedGredorfardig || !hasDownloadedPdf"
      :previous-button-hidden="currentStepNumber === 1"
      next-button-text="Klar"
      @go-to-previous-step="emit('goToPreviousStep')"
      @go-to-next-step="emit('goToNextStep')"
    />
  </div>
</template>

<style lang="scss" scoped>
@import "@/assets/_variables.scss";

.file-zone {
  border: 1px solid $border-color-dark;
  border-radius: var(--bs-border-radius);
  padding: 0.5rem 1rem;
  margin-bottom: 1rem;
}

.download-zone {
  display: flex;
  align-items: center;
  justify-content: center;

  height: 5rem;
}

a {
  font-weight: bold;
}
</style>
